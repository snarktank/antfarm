# Progress Log
Run: c62db3ad-4df1-4385-887c-00999dd2739f
Task: Create cost tracking dashboard for Antfarm
Started: 2026-02-09T21:12:00-05:00

## Codebase Patterns
- Uses `node:sqlite` DatabaseSync (synchronous, not async)
- Tables created in `migrate()` function in `src/db.ts`
- Pattern: `CREATE TABLE IF NOT EXISTS` for idempotent migrations
- Pattern: `ALTER TABLE ADD COLUMN` for backwards-compatible schema changes
- Tests use `node:test` with `node --test dist/*.test.js`
- Build: `npm run build` (runs tsc, copies HTML, chmod cli)
- DB columns use snake_case (run_id), TS types use camelCase (runId) - map with helper function
- Nullable DB columns map to `undefined` in TS types, not `null`
- Dashboard uses raw `http.createServer` with manual routing in src/server/dashboard.ts
- API endpoints use `json(res, data, status)` helper for JSON responses
- For POST endpoints: parse body with async `parseBody(req)` helper, then validate
- For UI structure tests: use fetchHTML helper, verify HTML with includes() and regex matching
- Tab navigation pattern: data-tab attributes, classList.toggle for active states, view-container active/inactive

---

## 2026-02-09 21:15 - US-001: Add usage table to database schema
- Added `usage` table to db.ts migrate() function
- Columns: id, run_id (nullable FK), step_id, agent_id, model, input_tokens, output_tokens, cost_usd, task_label, created_at
- Created indexes on agent_id, model, created_at
- Created src/db.test.ts with 4 tests verifying table structure, indexes, and insert behavior
- **Learnings:** Project had no test infrastructure - added first test file using node:test
---

## 2026-02-09 21:22 - US-002: Add usage data types and helper functions
- Added `UsageRecord` type to src/installer/types.ts with camelCase fields
- Created src/installer/usage.ts with:
  - `insertUsage(record)` - inserts and returns id, auto-generates id/createdAt if not provided
  - `getUsageByRunId(runId)` - returns all records for a run, ordered by created_at
  - `getUsageByAgentId(agentId)` - returns all records for an agent, ordered by created_at
- Created src/installer/usage.test.ts with 7 tests covering insert, retrieval, empty results, null handling
- **Learnings:** DB uses snake_case (run_id), TS types use camelCase (runId). Map with helper function.
---

## 2026-02-09 21:32 - US-003: Add POST /api/usage endpoint to record usage
- Added POST /api/usage handler to src/server/dashboard.ts
- Accepts JSON body with: agent_id, model (required), input_tokens, output_tokens, cost_usd, run_id, step_id, task_label (optional)
- Returns 400 with error message if agent_id or model is missing
- Returns 400 with "Invalid run_id reference" if FK constraint fails
- Returns 201 with {id: ...} on success
- Created src/server/dashboard.test.ts with 10 tests covering validation, success cases, and error handling
- **Learnings:** Dashboard uses raw http.createServer with manual routing. Use async handler and parseBody helper. FK constraints on usage.run_id mean client must provide valid run_id or omit it.
---

## 2026-02-09 21:42 - US-004: Add GET /api/usage endpoint with aggregation
- Added GET /api/usage handler to src/server/dashboard.ts
- Added `getAggregatedUsage()` function to src/installer/usage.ts with types `UsageAggregate` and `GroupedUsageAggregate`
- Supports query params: group_by (agent|model|task|day), from_date, to_date, agent_id, model
- Returns aggregated totals: totalInputTokens, totalOutputTokens, totalCostUsd, recordCount
- When group_by is specified, returns array with groupKey field for each group
- Added 10 tests to dashboard.test.ts covering all aggregation and filtering scenarios
- **Learnings:** Use COALESCE(SUM(...), 0) in SQLite to return 0 instead of null for empty aggregates. DATE() function extracts date portion from ISO timestamps. Use unique test data prefixes (timestamps) to isolate tests from persisted DB data.
---

## 2026-02-09 21:52 - US-005: Add tab navigation UI to dashboard
- Added tab bar below header in index.html with 'Runs' and 'Costs' tabs
- Added CSS for .tab-bar, .tab-btn, .tab-btn.active, .view-container styles matching green/cream theme
- Active tab gets green underline via ::after pseudo-element
- Wrapped board in #runs-view container, added #costs-view container
- Added initTabs() IIFE for tab switching via data-tab attributes and classList.toggle
- Added 6 tests to dashboard.test.ts verifying HTML structure, default state, CSS rules, and JS presence
- Files changed: src/server/index.html, src/server/dashboard.test.ts
- **Learnings:** For UI tests without browser DOM, fetch HTML and use string matching/regex to verify structure. Use fetchHTML helper separate from JSON request helper.
---

## 2026-02-09 22:05 - US-006: Add costs summary cards to costs view
- Added 4 summary cards to costs-view: Total Input Tokens, Total Output Tokens, Total Cost (USD), Total Requests
- Added CSS grid layout for cards matching dashboard theme (bg-surface, border, box-shadow, Geist Mono font for values)
- Added loadCostsSummary() function called when Costs tab is activated
- Added formatNumber() and formatCurrency() helpers with locale-based thousands separators
- Added 8 tests verifying card structure, CSS, and JavaScript functionality
- Files changed: src/server/index.html, src/server/dashboard.test.ts
- **Learnings:** For loading state in cards, toggle a .loading class for different styling. Use toLocaleString('en-US') for consistent number formatting.
---

## 2026-02-09 22:12 - US-007: Add costs breakdown by model table
- Added model breakdown table below summary cards in costs-view
- Table columns: Model, Input Tokens, Output Tokens, Cost, Requests
- Fetches data from GET /api/usage?group_by=model
- Sorts by total cost descending (highest cost models first)
- Added CSS styling matching dashboard theme (borders, hover states, numeric alignment)
- Added escapeHtml() helper for XSS protection on model names
- loadCostsSummary() now also calls loadModelBreakdown()
- Added 10 tests verifying table structure, CSS, and JavaScript functionality
- Files changed: src/server/index.html, src/server/dashboard.test.ts
- **Learnings:** Use colspan on placeholder rows for loading/empty states. Escape user-controlled content (model names) before rendering to HTML.
---

## 2026-02-09 22:22 - US-008: Add costs breakdown by agent table
- Added agent breakdown table below model breakdown in costs-view
- Reuses model-breakdown class and model-table styles for consistent appearance
- Table columns: Agent, Input Tokens, Output Tokens, Cost, Requests
- Fetches data from GET /api/usage?group_by=agent
- Sorts by total cost descending (highest cost agents first)
- Displays agent IDs (e.g., feature-dev-planner, feature-dev-developer)
- Uses escapeHtml() for XSS protection on agent IDs
- loadCostsSummary() now calls both loadModelBreakdown() and loadAgentBreakdown()
- Added 10 tests verifying agent table structure, JavaScript, and ordering
- Fixed pre-existing test that assumed only one table with numeric columns
- Files changed: src/server/index.html, src/server/dashboard.test.ts
- **Learnings:** Reuse existing CSS classes (model-breakdown, model-table) for consistency when adding similar components. Tests checking global HTML features may need scoping to specific elements when adding parallel structures.
---
