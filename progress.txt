# Progress Log
Run: cb386bdd-d5ae-4598-a622-187d6ec543e6
Task: Build a backlog column for antfarm
Started: 2026-02-11T03:07:00

## Codebase Patterns
- DB uses `node:sqlite` DatabaseSync (synchronous), not async
- Cast DB results through `unknown`: `.get() as unknown as Type`
- All tables created in `migrate()` in `src/db.ts`
- DB path overridable via `ANTFARM_DB_PATH` env var (useful for tests)
- Tests: `node:test` with `node:assert/strict`, compile with `tsconfig.test.json`, run with `ANTFARM_DB_PATH=/tmp/test.db node --test dist/tests/*.test.js`
- CLI command groups: add handler in main(), delegate to async function (e.g., handleBacklog)
- CLI supports ID prefix matching for user-facing commands
- Main build: `npm run build` (tsc with rootDir=src)
- Test build needs separate tsconfig.test.json (rootDir=. to include tests/)

---

## 2026-02-11 03:07 - S1: Backlog DB schema and CRUD operations
- Added `backlog_items` table to migrate() in db.ts
- Created src/backlog.ts with createItem, getItems, updateItem, deleteItem, reorderItem
- Added ANTFARM_DB_PATH env var support to db.ts for testability
- Created tests/backlog.test.ts with 12 tests covering all CRUD ops
- Created tsconfig.test.json for compiling tests
- Files changed: src/db.ts, src/backlog.ts, tests/backlog.test.ts, tsconfig.test.json
- **Learnings:** ESM modules need separate tsconfig for tests due to rootDir constraint; DB result casting requires `unknown` intermediate for strict TS
---

## 2026-02-11 03:17 - S2: Backlog REST API endpoints
- Added REST API routes to dashboard.ts: GET/POST /api/backlog, PATCH/DELETE /api/backlog/:id, POST reorder & dispatch
- Dispatch validates target_workflow is set and exists in loaded workflows, calls runWorkflow, updates status
- Made server handler async to support body parsing
- Added readBody helper, CORS preflight handling
- Created tests/backlog-api.test.ts with 16 tests covering all endpoints, error cases, and edge cases
- Files changed: src/server/dashboard.ts, tests/backlog-api.test.ts, .gitignore
- **Learnings:** Dashboard server handler can be async with http.createServer; body parsing needs manual implementation (no express)
---

## 2026-02-11 03:27 - S3: Backlog CLI commands
- Added `antfarm backlog` command group in cli.ts: list, add, update, delete, dispatch, reorder
- Supports --workflow, --desc flags on add; --title, --desc, --workflow on update
- Prefix matching for item IDs (use first 8 chars of UUID)
- Dispatch calls runWorkflow and marks item as "dispatched"
- Updated printUsage() with all backlog commands
- Created tests/backlog-cli.test.ts with 11 tests covering all commands and error cases
- Files changed: src/cli/cli.ts, tests/backlog-cli.test.ts
- **Learnings:** CLI tests need to use compiled paths (dist/cli/cli.js from dist/tests/); prefix ID matching needs fallback to raw input for proper error messages
---

## 2026-02-11 03:37 - S4: Dashboard UI - Backlog column
- Added Backlog column as leftmost column in src/server/index.html
- Backlog form: title input, description textarea, workflow dropdown, Add button
- Cards show title, truncated desc (2-line clamp), workflow badge, status badge, dispatch button
- JS functions: loadBacklog, renderBacklogColumn, addBacklogItem, dispatchBacklog, refreshBoard
- Backlog auto-refreshes with 30s interval alongside workflow runs
- Created tests/backlog-dashboard.test.ts with 21 tests (HTML structure parsing, no server needed)
- Files changed: src/server/index.html, tests/backlog-dashboard.test.ts
- **Learnings:** Testing server-rendered HTML by reading the file directly avoids server lifecycle issues with node:test; resolve paths carefully when tests run from dist/
---

## 2026-02-11 03:47 - S4 (retry): Fix CLI test path resolution
- Fixed tests/backlog-cli.test.ts path resolution: detect compiled vs source context using `__dirname.includes("dist/tests")`
- When compiled (dist/tests/), CLI is at `../cli/cli.js`; when source (tests/), CLI is at `../dist/cli/cli.js`
- All 60 tests passing (11 CLI + 16 API + 12 CRUD + 21 dashboard)
- Files changed: tests/backlog-cli.test.ts
- **Learnings:** CLI tests that shell out to `node <cli.js>` need path detection for compiled vs tsx execution contexts
---

## 2026-02-11 03:57 - S5: Dashboard UI - Backlog item actions (edit, delete, dispatch, reorder)
- Added click-to-open detail panel for backlog cards with editable title, description, workflow selector
- Save button calls PATCH /api/backlog/:id, Delete button with confirm() calls DELETE
- Dispatch button in panel calls POST /api/backlog/:id/dispatch (disabled when no workflow)
- Up/down arrow reorder buttons on cards call POST /api/backlog/:id/reorder
- Dispatched items show strikethrough title, reduced opacity, green left border
- Dispatched items have "View dispatched run" link in detail panel
- Detail panel disables all fields for dispatched items
- Created tests/backlog-actions.test.ts with 28 tests covering all new UI interactions
- Updated tests/backlog-dashboard.test.ts to match refactored dispatch logic
- All 88 tests passing (28 actions + 21 dashboard + 16 API + 12 CRUD + 11 CLI)
- Files changed: src/server/index.html, tests/backlog-actions.test.ts, tests/backlog-dashboard.test.ts
- **Learnings:** Reusing the existing overlay/panel pattern from run details works well for backlog detail panels; event.stopPropagation() needed on nested buttons to prevent card click handler
---
