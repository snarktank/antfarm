# Progress Log
Run: 047f8650-e1d3-4695-bf25-8390e26b061c
Task: Add easter egg ant command to antfarm CLI
Started: 2026-02-11 05:47 ET

## Codebase Patterns
- CLI entry: `src/cli/cli.ts`, commands matched via `group` variable from `process.argv[2]`
- Dynamic imports used for command modules (e.g., `await import("./ant.js")`)
- Build: `npm run build` runs `tsc -p tsconfig.json` + copies HTML + chmod
- Tests: `node --test dist/<file>.test.js` (node:test + node:assert/strict)
- ESM with NodeNext module resolution, `.js` extensions in imports

---

## 2026-02-11 05:47 - US-001: Add ant easter egg module with ASCII art and quotes
- Created `src/cli/ant.ts` with `printAnt()` function, 10 quotes, ASCII ant art
- Created `src/cli/ant.test.ts` with 4 tests (art output, quote output, 8+ unique quotes, no-throw)
- Wired `ant` command into `src/cli/cli.ts` via dynamic import
- Files changed: `src/cli/ant.ts` (new), `src/cli/ant.test.ts` (new), `src/cli/cli.ts` (modified)
- **Learnings:** CLI uses simple if-chain for command routing, not a framework
---

## 2026-02-11 05:52 - US-002: Wire ant command into CLI and add tests
- Created `tests/ant.test.ts` with 3 CLI integration tests (ASCII art, quote output, hidden from help)
- Tests use child_process.execFileSync to run the actual CLI binary
- All acceptance criteria verified: CLI works, hidden from help, tests pass, build passes
- Files changed: `tests/ant.test.ts` (new)
- **Learnings:** Node 22 runs .ts files directly with type stripping; tests in `tests/` use this approach
---

## 2026-02-12 17:10 - story-1: Create version injection build script
- Created `scripts/inject-version.js` â€” reads version from package.json, replaces {{VERSION}} in landing/index.html
- Script is idempotent: handles both placeholder and previously injected versions
- Added `v{{VERSION}}` badge markup to landing/index.html (class="version-badge")
- Created `scripts/__tests__/inject-version.test.js` with 3 tests (placeholder replacement, idempotency, correct semver)
- All 3 tests pass, build passes, typecheck passes
- 2 pre-existing landing test failures unrelated to this story (missing id="features", id="quickstart", .feature-grid)
- **Learnings:** Landing page uses plain HTML, no build pipeline yet for HTML transforms

## 2026-02-12 17:15 - story-2: Add version badge to landing page HTML and CSS, wire into build
- Added .version-badge styles to landing/style.css (pill badge, accent green bg, mono font)
- Updated package.json build script to run `node scripts/inject-version.js` after tsc
- Added version badge test to landing/__tests__/landing.test.js (checks element exists + valid semver)
- Build successfully injects version 0.2.3 into landing page
- Version badge test passes; 2 pre-existing test failures unchanged (missing id="features", .feature-grid)
- Files changed: landing/style.css, package.json, landing/__tests__/landing.test.js

## 2026-02-13 03:42 - 1-workflow-polling-config: Add pollingModel and pollingTimeoutSeconds to workflow YAML schema
- Added `PollingConfig` type with `model` and `timeoutSeconds` fields to types.ts
- Added optional `polling` field to `WorkflowSpec` type
- Added optional `pollingModel` field to `WorkflowAgent` type
- Added `validatePollingConfig` in workflow-spec.ts (rejects non-positive timeoutSeconds)
- Created tests/polling-config.test.ts with 4 tests: top-level parsing, per-agent pollingModel, backward compat, invalid timeout rejection
- All tests pass, build passes, typecheck passes
- Files changed: src/installer/types.ts, src/installer/workflow-spec.ts, tests/polling-config.test.ts
- **Learnings:** YAML fields pass through to typed objects automatically via YAML.parse; just need type definitions and optional validation

## 2026-02-13 03:52 - 2-build-polling-prompt: Create minimal polling prompt builder in agent-cron.ts
- Added exported `buildPollingPrompt(workflowId, agentId)` function to agent-cron.ts
- Generates minimal prompt (~250 chars) with just: step claim command, NO_WORK->HEARTBEAT_OK logic
- No AGENTS.md, SOUL.md, step complete/fail, or workflow context in polling prompt
- Created tests/polling-prompt.test.ts with 5 tests: correct claim command, HEARTBEAT_OK instruction, no heavy content, under 2000 chars, different agent ids
- All tests pass, build passes, typecheck passes
- Files changed: src/installer/agent-cron.ts (modified), tests/polling-prompt.test.ts (new)

## 2026-02-13 03:57 - 3-build-work-prompt: Create full work execution prompt builder in agent-cron.ts
- Added exported `buildWorkPrompt(workflowId, agentId)` function to agent-cron.ts
- Contains full step execution instructions (steps 2-4 from original buildAgentPrompt)
- Includes step complete/fail reporting, critical warnings, rules
- Does NOT include step claim command (Phase 1 handles that)
- Created tests/work-prompt.test.ts with 6 tests: complete instructions, fail instructions, no claim, critical warning, no HEARTBEAT_OK/NO_WORK, different ids
- All tests pass, build passes, typecheck passes
- Files changed: src/installer/agent-cron.ts (modified), tests/work-prompt.test.ts (new)

## 2026-02-13 04:52 - 9-gateway-api-model-support: Add model parameter support to createAgentCronJob
- createAgentCronJob already had model? in payload type + delivery? field (added in stories 4+)
- Fixed merge conflict artifacts (leftover commit message text on delivery lines)
- Created tests/gateway-api-model.test.ts with 5 tests: model in payload, backward compat, HTTP body, CLI fallback, delivery+model together
- Tests mock globalThis.fetch to verify model passes through HTTP path
- All 105 tests pass, build passes, typecheck passes
- Files changed: src/installer/gateway-api.ts (cleanup), tests/gateway-api-model.test.ts (new, committed in prior fix)
- **Learnings:** Merge conflict resolution can leave artifacts beyond standard markers; always grep for commit message text in source

---

## 2026-02-14 05:45 - fix-002: Harden Antfarm Database Permissions
- Restricted database directory permissions to 0700 (owner only)
- Restricted database file permissions to 0600 (owner only)
- Added `fs.chmodSync` in `src/db.ts` to enforce permissions on creation and if they were loose
- Created `tests/security-db-permissions.test.ts` as a regression test
- All 164 tests pass
- Files changed: src/db.ts, tests/security-db-permissions.test.ts
