<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antfarm Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Geist+Mono&display=swap" rel="stylesheet">
<style>
/* ── Theme tokens ──────────────────────────────────────────────── */
:root {
  --bg-page: #FAF8F5;
  --bg-surface: #fff;
  --bg-surface-alt: #FAF8F5;
  --bg-column-header: #f5f0e8;
  --text-primary: #3A3226;
  --text-secondary: #8b8072;
  --text-tertiary: #5a5045;
  --border: #D4C4A0;
  --border-light: #eee;
  --shadow: rgba(58, 50, 38, .1);
  --shadow-heavy: rgba(58, 50, 38, .15);
  --overlay: rgba(58, 50, 38, .5);

  /* Header */
  --header-bg: #6B7F3B;
  --header-border: #5a6b32;
  --header-select-bg: #5a6b32;
  --header-select-border: #4a5a28;

  /* Accents — shared across themes */
  --accent-green: #6B7F3B;
  --accent-green-subtle: #6B7F3B22;
  --accent-teal: #3a9e8a;
  --accent-teal-subtle: #8ECFC033;
  --accent-orange: #E8845C;
  --accent-orange-subtle: #E8845C22;
  --accent-muted: #D4C4A044;
  --accent-orange-faint: #E8845C11;
  --accent-highlight: #D4E8A0;

  /* Pre/code */
  --bg-code: #FAF8F5;
}

[data-theme="dark"] {
  --bg-page: #1a1917;
  --bg-surface: #262521;
  --bg-surface-alt: #1f1e1b;
  --bg-column-header: #2a2926;
  --text-primary: #e0d8ce;
  --text-secondary: #9a9088;
  --text-tertiary: #b0a89e;
  --border: #3d3a34;
  --border-light: #333;
  --shadow: rgba(0, 0, 0, .25);
  --shadow-heavy: rgba(0, 0, 0, .4);
  --overlay: rgba(0, 0, 0, .6);

  --header-bg: #2d3320;
  --header-border: #3a4228;
  --header-select-bg: #3a4228;
  --header-select-border: #4a5438;

  --accent-green: #8fa74e;
  --accent-green-subtle: rgba(143, 167, 78, .15);
  --accent-teal: #6bc4b0;
  --accent-teal-subtle: rgba(107, 196, 176, .15);
  --accent-orange: #e8955f;
  --accent-orange-subtle: rgba(232, 149, 95, .15);
  --accent-muted: rgba(255, 255, 255, .06);
  --accent-orange-faint: rgba(232, 149, 95, .08);
  --accent-highlight: #b5cc80;

  --bg-code: #1f1e1b;
}

/* ── Auto dark mode when no explicit preference ───────────────── */
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) {
    --bg-page: #1a1917;
    --bg-surface: #262521;
    --bg-surface-alt: #1f1e1b;
    --bg-column-header: #2a2926;
    --text-primary: #e0d8ce;
    --text-secondary: #9a9088;
    --text-tertiary: #b0a89e;
    --border: #3d3a34;
    --border-light: #333;
    --shadow: rgba(0, 0, 0, .25);
    --shadow-heavy: rgba(0, 0, 0, .4);
    --overlay: rgba(0, 0, 0, .6);

    --header-bg: #2d3320;
    --header-border: #3a4228;
    --header-select-bg: #3a4228;
    --header-select-border: #4a5438;

    --accent-green: #8fa74e;
    --accent-green-subtle: rgba(143, 167, 78, .15);
    --accent-teal: #6bc4b0;
    --accent-teal-subtle: rgba(107, 196, 176, .15);
    --accent-orange: #e8955f;
    --accent-orange-subtle: rgba(232, 149, 95, .15);
    --accent-muted: rgba(255, 255, 255, .06);
    --accent-orange-faint: rgba(232, 149, 95, .08);
    --accent-highlight: #b5cc80;

    --bg-code: #1f1e1b;
  }
}

/* ── Base ──────────────────────────────────────────────────────── */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-page);color:var(--text-primary);min-height:100vh}
header{background:var(--header-bg);border-bottom:2px solid var(--header-border);padding:12px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
header img{height:36px;border-radius:6px}
header h1{font-family:'Inter',sans-serif;font-size:22px;font-weight:600;color:#fff;letter-spacing:0}
header h1 span{color:var(--accent-highlight)}
select{background:var(--header-select-bg);color:#fff;border:1px solid var(--header-select-border);border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer}
select option{background:var(--header-select-bg);color:#fff}
select:focus{outline:none;border-color:#8ECFC0}

/* ── Theme toggle ─────────────────────────────────────────────── */
.theme-toggle{background:none;border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#fff;cursor:pointer;padding:5px 8px;font-size:16px;line-height:1;transition:border-color .15s}
.theme-toggle:hover{border-color:rgba(255,255,255,.5)}

/* ── Board ─────────────────────────────────────────────────────── */
.board{display:flex;gap:16px;padding:24px;overflow-x:auto;min-height:calc(100vh - 65px)}
.column{min-width:240px;flex:1;background:var(--bg-surface);border:none;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 2px 8px var(--shadow)}
.column-header{padding:12px 16px;border-bottom:1px solid var(--border-light);font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--accent-green);background:var(--bg-column-header);border-radius:8px 8px 0 0}
.column-header .count{background:var(--accent-green);color:#fff;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:8px}
.cards{padding:8px;flex:1;display:flex;flex-direction:column;gap:8px;overflow-y:auto}

/* ── Cards ─────────────────────────────────────────────────────── */
.card{background:var(--bg-surface-alt);border:1px solid var(--border);border-radius:6px;padding:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.card:hover{border-color:var(--accent-orange);box-shadow:0 2px 8px var(--accent-orange-subtle)}
.card-title{font-size:13px;font-weight:500;color:var(--text-primary);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-meta{font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;align-items:center}
.card.done{border-left:3px solid var(--accent-green)}
.card.failed,.card.error{border-left:3px solid var(--accent-orange)}

/* ── Overlay / Panel ───────────────────────────────────────────── */
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--overlay);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s}
.overlay.open{opacity:1;pointer-events:auto}
.panel{background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto;padding:24px;position:relative;box-shadow:0 8px 32px var(--shadow-heavy)}
.panel-close{position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.panel-close:hover{color:var(--text-primary);background:var(--bg-column-header)}
.panel h2{font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:4px;padding-right:40px}
.panel-task{font-size:13px;color:var(--text-secondary);margin-bottom:16px;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow-y:auto;line-height:1.5}
.panel-meta{display:flex;gap:12px;margin-bottom:20px;font-size:12px;color:var(--text-secondary);flex-wrap:wrap}
.panel-meta span{display:flex;align-items:center;gap:4px}

/* ── Steps ─────────────────────────────────────────────────────── */
.steps-list{display:flex;flex-direction:column;gap:8px}
.step-row{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg-surface-alt);border:1px solid var(--border);border-radius:6px}
.step-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.step-icon.done{background:var(--accent-green-subtle);color:var(--accent-green)}
.step-icon.running{background:var(--accent-teal-subtle);color:var(--accent-teal)}
.step-icon.pending{background:var(--accent-muted);color:var(--text-secondary)}
.step-icon.waiting{background:var(--accent-muted);color:var(--text-secondary)}
.step-icon.failed,.step-icon.error{background:var(--accent-orange-subtle);color:var(--accent-orange)}
.step-name{font-size:13px;font-weight:500;color:var(--text-primary);flex:1}
.step-agent{font-size:11px;color:var(--text-secondary);font-family:'Geist Mono',monospace}
.step-status{font-size:11px;text-transform:uppercase;font-weight:600}

/* ── Badges ────────────────────────────────────────────────────── */
.badge{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;text-transform:uppercase}
.badge-running{background:var(--accent-teal-subtle);color:var(--accent-teal)}
.badge-done,.badge-completed{background:var(--accent-green-subtle);color:var(--accent-green)}
.badge-failed,.badge-error{background:var(--accent-orange-subtle);color:var(--accent-orange)}
.badge-waiting{background:var(--accent-muted);color:var(--text-secondary)}
.badge-pending{background:var(--accent-muted);color:var(--text-secondary)}
.badge-blocked{background:var(--accent-orange-faint);color:var(--accent-orange)}

/* ── Misc ──────────────────────────────────────────────────────── */
.empty{color:var(--text-secondary);font-size:12px;text-align:center;padding:24px 8px}
.refresh-note{color:rgba(255,255,255,.6);font-size:11px;margin-left:auto}
@media(max-width:768px){.board{flex-direction:column}.column{min-width:unset}}
.story-open{display:block!important}
.story-chevron-open{transform:rotate(90deg)}

/* ── Tab Navigation ────────────────────────────────────────────── */
.tab-bar{display:flex;gap:0;background:var(--bg-surface);border-bottom:1px solid var(--border);padding:0 24px}
.tab-btn{background:none;border:none;padding:12px 20px;font-family:'Inter',sans-serif;font-size:14px;font-weight:500;color:var(--text-secondary);cursor:pointer;position:relative;transition:color .15s}
.tab-btn:hover{color:var(--text-primary)}
.tab-btn.active{color:var(--accent-green)}
.tab-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent-green);border-radius:2px 2px 0 0}
.view-container{display:none;min-height:calc(100vh - 110px)}
.view-container.active{display:block}
#costs-view{padding:24px}
#costs-view .empty{color:var(--text-secondary);font-size:14px;text-align:center;padding:48px 24px}

/* ── Summary Cards ─────────────────────────────────────────────── */
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px}
.summary-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:20px;box-shadow:0 2px 8px var(--shadow)}
.summary-card-label{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:8px}
.summary-card-value{font-size:28px;font-weight:600;color:var(--text-primary);font-family:'Geist Mono','Inter',monospace}
.summary-card-value.loading{color:var(--text-secondary);font-size:14px;font-weight:400}

/* ── Model Breakdown Table ─────────────────────────────────────── */
.model-breakdown{margin-bottom:24px}
.model-breakdown-title{font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:12px}
.model-table{width:100%;border-collapse:collapse;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;box-shadow:0 2px 8px var(--shadow)}
.model-table th{background:var(--bg-column-header);padding:12px 16px;text-align:left;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);border-bottom:1px solid var(--border)}
.model-table td{padding:12px 16px;font-size:13px;color:var(--text-primary);border-bottom:1px solid var(--border-light)}
.model-table tr:last-child td{border-bottom:none}
.model-table tr:hover td{background:var(--bg-surface-alt)}
.model-table .numeric{text-align:right;font-family:'Geist Mono','Inter',monospace}
.model-table .model-name{font-weight:500}
.model-table-loading{padding:24px;text-align:center;color:var(--text-secondary);font-size:14px}
.model-table-empty{padding:24px;text-align:center;color:var(--text-secondary);font-size:14px}

/* ── Date Filter ───────────────────────────────────────────────── */
.date-filter{display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.date-filter-group{display:flex;align-items:center;gap:8px}
.date-filter-label{font-size:13px;font-weight:500;color:var(--text-secondary)}
.date-filter-input{background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-family:'Inter',sans-serif;font-size:13px;cursor:pointer}
.date-filter-input:focus{outline:none;border-color:var(--accent-green)}
.date-filter-input::-webkit-calendar-picker-indicator{cursor:pointer;filter:opacity(0.6)}
[data-theme="dark"] .date-filter-input::-webkit-calendar-picker-indicator{filter:invert(1) opacity(0.6)}
@media (prefers-color-scheme: dark) {:root:not([data-theme="light"]) .date-filter-input::-webkit-calendar-picker-indicator{filter:invert(1) opacity(0.6)}}

/* ── Model Filter ──────────────────────────────────────────────── */
.model-filter-select{background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-family:'Inter',sans-serif;font-size:13px;cursor:pointer;min-width:180px}
.model-filter-select:focus{outline:none;border-color:var(--accent-green)}
.model-filter-select option{background:var(--bg-surface);color:var(--text-primary)}

/* ── Daily Usage Chart ─────────────────────────────────────────── */
.daily-chart-container{margin-bottom:24px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:20px;box-shadow:0 2px 8px var(--shadow);position:relative}
.daily-chart-title{font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:16px}
.daily-chart-svg{width:100%;height:200px;display:block}
.daily-chart-bar{fill:var(--accent-green);cursor:pointer;transition:fill .15s}
.daily-chart-bar:hover{fill:var(--accent-teal)}
.daily-chart-axis-line{stroke:var(--border);stroke-width:1}
.daily-chart-axis-label{fill:var(--text-secondary);font-size:10px;font-family:'Inter',sans-serif}
.daily-chart-grid-line{stroke:var(--border-light);stroke-width:1;stroke-dasharray:4,4}
.daily-chart-tooltip{position:absolute;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--text-primary);box-shadow:0 4px 12px var(--shadow-heavy);pointer-events:none;z-index:10;white-space:nowrap}
.daily-chart-tooltip-date{font-weight:500;margin-bottom:2px}
.daily-chart-tooltip-value{color:var(--accent-green);font-family:'Geist Mono',monospace}
.daily-chart-empty{text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:14px}
.daily-chart-loading{text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:14px}

/* ── Usage Log ─────────────────────────────────────────────────── */
.usage-log-section{margin-top:24px}
.usage-log-header{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:background .15s}
.usage-log-header:hover{background:var(--bg-surface-alt)}
.usage-log-chevron{color:var(--text-secondary);font-size:12px;transition:transform .2s}
.usage-log-chevron.open{transform:rotate(90deg)}
.usage-log-title{font-size:15px;font-weight:600;color:var(--text-primary);flex:1}
.usage-log-count{font-size:12px;color:var(--text-secondary)}
.usage-log-content{display:none;margin-top:-1px;background:var(--bg-surface);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;overflow:hidden}
.usage-log-content.open{display:block}
.usage-log-table{width:100%;border-collapse:collapse}
.usage-log-table th{background:var(--bg-column-header);padding:10px 12px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);border-bottom:1px solid var(--border)}
.usage-log-table td{padding:10px 12px;font-size:12px;color:var(--text-primary);border-bottom:1px solid var(--border-light)}
.usage-log-table tr:last-child td{border-bottom:none}
.usage-log-table tr:hover td{background:var(--bg-surface-alt)}
.usage-log-table .numeric{text-align:right;font-family:'Geist Mono','Inter',monospace}
.usage-log-table .timestamp{font-family:'Geist Mono','Inter',monospace;font-size:11px;color:var(--text-secondary);white-space:nowrap}
.usage-log-table .task-cell{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.usage-log-empty{padding:24px;text-align:center;color:var(--text-secondary);font-size:13px}
.usage-log-loading{padding:24px;text-align:center;color:var(--text-secondary);font-size:13px}
.usage-log-pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg-column-header);border-top:1px solid var(--border)}
.usage-log-pagination-info{font-size:12px;color:var(--text-secondary)}
.usage-log-pagination-controls{display:flex;gap:8px}
.usage-log-pagination-btn{background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:6px 12px;font-size:12px;color:var(--text-primary);cursor:pointer;transition:background .15s,border-color .15s}
.usage-log-pagination-btn:hover:not(:disabled){background:var(--bg-surface-alt);border-color:var(--accent-green)}
.usage-log-pagination-btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <h1><span>antfarm</span> dashboard</h1>
  <select id="wf-select"><option value="">Loading...</option></select>
  <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode" aria-label="Toggle light/dark mode">☀️</button>
  <span class="refresh-note" id="refresh-note">Auto-refresh: 30s</span>
</header>
<div class="tab-bar" id="tab-bar">
  <button class="tab-btn active" data-tab="runs">Runs</button>
  <button class="tab-btn" data-tab="costs">Costs</button>
</div>
<div id="runs-view" class="view-container active">
  <div class="board" id="board"><div class="empty" style="margin:auto">Select a workflow</div></div>
</div>
<div id="costs-view" class="view-container">
  <div class="date-filter" id="date-filter">
    <div class="date-filter-group">
      <label class="date-filter-label" for="date-from">From</label>
      <input type="date" id="date-from" class="date-filter-input">
    </div>
    <div class="date-filter-group">
      <label class="date-filter-label" for="date-to">To</label>
      <input type="date" id="date-to" class="date-filter-input">
    </div>
    <div class="date-filter-group">
      <label class="date-filter-label" for="model-filter">Model</label>
      <select id="model-filter" class="model-filter-select">
        <option value="">All Models</option>
      </select>
    </div>
  </div>
  <div class="summary-cards" id="summary-cards">
    <div class="summary-card">
      <div class="summary-card-label">Total Input Tokens</div>
      <div class="summary-card-value" id="card-input-tokens">—</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-label">Total Output Tokens</div>
      <div class="summary-card-value" id="card-output-tokens">—</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-label">Total Cost (USD)</div>
      <div class="summary-card-value" id="card-total-cost">—</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-label">Total Requests</div>
      <div class="summary-card-value" id="card-total-requests">—</div>
    </div>
  </div>
  <div class="daily-chart-container" id="daily-chart-container">
    <div class="daily-chart-title">Daily Usage Trend</div>
    <div id="daily-chart-content" class="daily-chart-loading">Loading...</div>
  </div>
  <div class="model-breakdown" id="model-breakdown">
    <div class="model-breakdown-title">Cost by Model</div>
    <table class="model-table" id="model-table">
      <thead>
        <tr>
          <th>Model</th>
          <th class="numeric">Input Tokens</th>
          <th class="numeric">Output Tokens</th>
          <th class="numeric">Cost</th>
          <th class="numeric">Requests</th>
        </tr>
      </thead>
      <tbody id="model-table-body">
        <tr><td colspan="5" class="model-table-loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="model-breakdown" id="agent-breakdown">
    <div class="model-breakdown-title">Cost by Agent</div>
    <table class="model-table" id="agent-table">
      <thead>
        <tr>
          <th>Agent</th>
          <th class="numeric">Input Tokens</th>
          <th class="numeric">Output Tokens</th>
          <th class="numeric">Cost</th>
          <th class="numeric">Requests</th>
        </tr>
      </thead>
      <tbody id="agent-table-body">
        <tr><td colspan="5" class="model-table-loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="usage-log-section" id="usage-log-section">
    <div class="usage-log-header" id="usage-log-header">
      <span class="usage-log-chevron" id="usage-log-chevron">▶</span>
      <span class="usage-log-title">Usage Log</span>
      <span class="usage-log-count" id="usage-log-count"></span>
    </div>
    <div class="usage-log-content" id="usage-log-content">
      <table class="usage-log-table" id="usage-log-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Agent</th>
            <th>Model</th>
            <th class="numeric">Input</th>
            <th class="numeric">Output</th>
            <th class="numeric">Cost</th>
            <th>Task</th>
          </tr>
        </thead>
        <tbody id="usage-log-body">
          <tr><td colspan="7" class="usage-log-loading">Loading...</td></tr>
        </tbody>
      </table>
      <div class="usage-log-pagination" id="usage-log-pagination">
        <div class="usage-log-pagination-info" id="usage-log-pagination-info">—</div>
        <div class="usage-log-pagination-controls">
          <button class="usage-log-pagination-btn" id="usage-log-prev" disabled>← Prev</button>
          <button class="usage-log-pagination-btn" id="usage-log-next" disabled>Next →</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="overlay" id="overlay" onclick="if(event.target===this)closePanel()">
  <div class="panel" id="panel"></div>
</div>

<script>
const API = '';
let workflows = [];
let currentWf = null;

async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function loadWorkflows() {
  workflows = await fetchJSON('/api/workflows');
  const sel = document.getElementById('wf-select');
  sel.innerHTML = '<option value="">— select workflow —</option>' +
    workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  if (workflows.length === 1) {
    sel.value = workflows[0].id;
    selectWorkflow(workflows[0].id);
  } else if (workflows.length > 1) {
    // Auto-select workflow with active runs
    try {
      for (const w of workflows) {
        const runs = await fetchJSON(`/api/runs?workflow=${w.id}`);
        const active = runs.find(r => r.status === 'running' || r.status === 'pending');
        if (active) { sel.value = w.id; selectWorkflow(w.id); break; }
      }
    } catch {}
  }
}

function selectWorkflow(id) {
  currentWf = workflows.find(w => w.id === id) || null;
  if (currentWf) loadRuns();
  else document.getElementById('board').innerHTML = '<div class="empty" style="margin:auto">Select a workflow</div>';
}

async function loadRuns() {
  if (!currentWf) return;
  const runs = await fetchJSON(`/api/runs?workflow=${currentWf.id}`);
  renderBoard(currentWf, runs);
}

function getActiveStepId(run) {
  if (!run.steps || !run.steps.length) return null;
  const active = run.steps.find(s => s.status !== 'done' && s.status !== 'skipped');
  return active ? active.step_id : run.steps[run.steps.length - 1].step_id;
}

function renderBoard(wf, runs) {
  const board = document.getElementById('board');
  const columns = {};
  wf.steps.forEach(s => { columns[s.id] = []; });

  runs.forEach(run => {
    const stepId = getActiveStepId(run);
    const col = stepId && columns[stepId] !== undefined ? stepId : wf.steps[wf.steps.length - 1]?.id;
    if (col && columns[col]) columns[col].push(run);
  });

  board.innerHTML = wf.steps.map(step => {
    const cards = columns[step.id];
    const cardHTML = cards.length === 0
      ? '<div class="empty">No runs</div>'
      : cards.map(run => {
          const isDone = run.status === 'done';
          const isFailed = run.status === 'failed' || run.status === 'error';
          const cls = isDone ? 'done' : isFailed ? 'failed' : '';
          const badge = `badge-${run.status}`;
          const time = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
          const title = run.task.length > 60 ? run.task.slice(0, 57) + '…' : run.task;
          return `<div class="card ${cls}" onclick="openRun('${run.id}')">
            <div class="card-title" title="${run.task.replace(/"/g, '&quot;')}">${title}</div>
            <div class="card-meta">
              <span class="badge ${badge}">${run.status}</span>
              <span>${time}</span>
            </div>
          </div>`;
        }).join('');
    return `<div class="column">
      <div class="column-header">${step.id}<span class="count">${cards.length}</span></div>
      <div class="cards">${cardHTML}</div>
    </div>`;
  }).join('');
}

const stepIcons = {done:'✓',running:'●',pending:'○',waiting:'◌',failed:'✗',error:'✗'};
function esc(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function openRun(id) {
  const run = await fetchJSON(`/api/runs/${id}`);
  const panel = document.getElementById('panel');
  const created = run.created_at ? new Date(run.created_at).toLocaleString() : '';
  const updated = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
  const stepsHTML = (run.steps || []).map(s => {
    const st = s.status || 'waiting';
    const icon = stepIcons[st] || '○';
    return `<div class="step-row">
      <div class="step-icon ${st}">${icon}</div>
      <div class="step-name">${s.step_id}</div>
      <div class="step-agent">${s.agent_id || ''}</div>
      <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
    </div>`;
  }).join('');
  panel.innerHTML = `
    <button class="panel-close" onclick="closePanel()">✕</button>
    <h2>${run.workflow_id}</h2>
    <div class="panel-task">${esc(run.task)}</div>
    <div class="panel-meta">
      <span><span class="badge badge-${run.status}">${run.status}</span></span>
      <span>Created: ${created}</span>
      <span>Updated: ${updated}</span>
    </div>
    <div class="steps-list">${stepsHTML}</div>
    <div id="stories-panel"></div>
  `;
  document.getElementById('overlay').classList.add('open');
  loadStories(id);
}

function closePanel() {
  document.getElementById('overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

async function loadStories(runId) {
  const stories = await fetchJSON(`/api/runs/${runId}/stories`);
  const panel = document.getElementById('stories-panel');
  if (!stories || stories.length === 0) { panel.innerHTML = ''; return; }
  const done = stories.filter(s => s.status === 'done').length;
  const pct = Math.round((done / stories.length) * 100);
  panel.innerHTML = `
    <div style="margin-top:24px;border-top:1px solid var(--border);padding-top:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-size:15px;font-weight:600;color:var(--text-primary)">Stories</h3>
        <span style="font-size:13px;font-weight:600;color:var(--accent-green)">${done} / ${stories.length} done</span>
      </div>
      <div style="background:var(--accent-muted);border-radius:4px;height:8px;margin-bottom:16px;overflow:hidden">
        <div style="background:var(--accent-green);height:100%;width:${pct}%;border-radius:4px;transition:width .3s"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${stories.map((s, i) => {
          const st = s.status || 'pending';
          const icon = stepIcons[st] || '○';
          let ac = [];
          try { ac = JSON.parse(s.acceptance_criteria || '[]'); } catch { ac = [s.acceptance_criteria]; }
          const retryInfo = s.retry_count > 0 ? ` <span style="color:var(--accent-orange);font-size:10px">(retry ${s.retry_count})</span>` : '';
          const hasDetails = s.description || ac.length > 0 || s.output;
          const toggleAttr = hasDetails ? `onclick="this.querySelector('.story-details').classList.toggle('story-open');this.querySelector('.story-chevron').classList.toggle('story-chevron-open')" style="cursor:pointer"` : '';
          return `<div class="step-row" style="flex-direction:column;align-items:stretch;gap:0;padding:0;overflow:hidden" ${toggleAttr}>
            <div style="display:flex;align-items:center;gap:8px;padding:10px 12px">
              <div class="step-icon ${st}">${icon}</div>
              <div class="step-name" style="flex:1">${s.story_id}: ${s.title}${retryInfo}</div>
              <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
              ${hasDetails ? '<span class="story-chevron" style="color:var(--text-secondary);font-size:10px;transition:transform .15s;display:inline-block">▶</span>' : ''}
            </div>
            ${hasDetails ? `<div class="story-details" style="display:none;padding:0 12px 12px 44px;font-size:12px;color:var(--text-tertiary);line-height:1.6">
              ${s.description ? `<div style="margin-bottom:8px">${esc(s.description)}</div>` : ''}
              ${ac.length > 0 ? `<div style="margin-bottom:8px"><div style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.3px;color:var(--accent-green);margin-bottom:4px">Acceptance Criteria</div>${ac.map(c => `<label style="display:flex;align-items:flex-start;gap:6px;margin-bottom:3px;cursor:default"><span style="color:var(${st==='done'?'--accent-green':'--border'});flex-shrink:0">${st==='done'?'☑':'☐'}</span><span>${esc(c)}</span></label>`).join('')}</div>` : ''}
              ${s.output ? `<details style="margin-top:4px" onclick="event.stopPropagation()"><summary style="font-size:11px;color:var(--text-secondary);cursor:pointer;font-weight:500">Output</summary><pre style="margin-top:6px;padding:8px;background:var(--bg-code);border:1px solid var(--border);border-radius:4px;font-family:'Geist Mono',monospace;font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto">${esc(s.output)}</pre></details>` : ''}
            </div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}

document.getElementById('wf-select').addEventListener('change', e => selectWorkflow(e.target.value));
loadWorkflows();
setInterval(() => { if (currentWf) loadRuns(); }, 30000);

// ── Tab Navigation ────────────────────────────────────────────────
(function initTabs() {
  const tabBar = document.getElementById('tab-bar');
  const tabs = tabBar.querySelectorAll('.tab-btn');
  const runsView = document.getElementById('runs-view');
  const costsView = document.getElementById('costs-view');

  function switchTab(tabName) {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    runsView.classList.toggle('active', tabName === 'runs');
    costsView.classList.toggle('active', tabName === 'costs');
    if (tabName === 'costs') loadCostsSummary();
  }

  tabBar.addEventListener('click', e => {
    const btn = e.target.closest('.tab-btn');
    if (btn && btn.dataset.tab) switchTab(btn.dataset.tab);
  });
})();

// ── Date Filter ───────────────────────────────────────────────────
(function initDateFilter() {
  const dateFrom = document.getElementById('date-from');
  const dateTo = document.getElementById('date-to');

  // Default to last 30 days
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);

  function toISODate(date) {
    return date.toISOString().split('T')[0];
  }

  dateFrom.value = toISODate(thirtyDaysAgo);
  dateTo.value = toISODate(today);

  dateFrom.addEventListener('change', loadCostsSummary);
  dateTo.addEventListener('change', loadCostsSummary);
})();

function getDateFilterParams() {
  const dateFrom = document.getElementById('date-from').value;
  const dateTo = document.getElementById('date-to').value;
  const params = new URLSearchParams();
  if (dateFrom) params.set('from_date', dateFrom);
  if (dateTo) params.set('to_date', dateTo);
  return params.toString();
}

function getModelFilterParam() {
  const modelFilter = document.getElementById('model-filter').value;
  return modelFilter || '';
}

function getFilterParams() {
  const params = new URLSearchParams();
  const dateFrom = document.getElementById('date-from').value;
  const dateTo = document.getElementById('date-to').value;
  const model = document.getElementById('model-filter').value;
  if (dateFrom) params.set('from_date', dateFrom);
  if (dateTo) params.set('to_date', dateTo);
  if (model) params.set('model', model);
  return params.toString();
}

// ── Model Filter ──────────────────────────────────────────────────
async function loadModelOptions() {
  const modelSelect = document.getElementById('model-filter');
  const currentValue = modelSelect.value;
  
  try {
    // Fetch all models (grouped by model, without date filter to get full list)
    const data = await fetchJSON('/api/usage?group_by=model');
    
    // Keep 'All Models' option, add distinct models
    const models = Array.isArray(data) ? data.map(r => r.groupKey).filter(Boolean).sort() : [];
    
    modelSelect.innerHTML = '<option value="">All Models</option>' +
      models.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
    
    // Restore previous selection if still valid
    if (currentValue && models.includes(currentValue)) {
      modelSelect.value = currentValue;
    }
  } catch (e) {
    // Keep just 'All Models' on error
    modelSelect.innerHTML = '<option value="">All Models</option>';
  }
}

(function initModelFilter() {
  const modelSelect = document.getElementById('model-filter');
  modelSelect.addEventListener('change', loadCostsSummary);
})();

// ── Costs Summary ─────────────────────────────────────────────────
function formatNumber(n) {
  if (n === null || n === undefined) return '—';
  return n.toLocaleString('en-US');
}

function formatCurrency(n) {
  if (n === null || n === undefined) return '—';
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

async function loadCostsSummary() {
  const cardInputTokens = document.getElementById('card-input-tokens');
  const cardOutputTokens = document.getElementById('card-output-tokens');
  const cardTotalCost = document.getElementById('card-total-cost');
  const cardTotalRequests = document.getElementById('card-total-requests');

  // Show loading state
  [cardInputTokens, cardOutputTokens, cardTotalCost, cardTotalRequests].forEach(el => {
    el.textContent = 'Loading...';
    el.classList.add('loading');
  });

  try {
    const filterParams = getFilterParams();
    const data = await fetchJSON('/api/usage' + (filterParams ? '?' + filterParams : ''));
    cardInputTokens.textContent = formatNumber(data.totalInputTokens);
    cardOutputTokens.textContent = formatNumber(data.totalOutputTokens);
    cardTotalCost.textContent = formatCurrency(data.totalCostUsd);
    cardTotalRequests.textContent = formatNumber(data.recordCount);
  } catch (e) {
    [cardInputTokens, cardOutputTokens, cardTotalCost, cardTotalRequests].forEach(el => {
      el.textContent = 'Error';
    });
  }

  [cardInputTokens, cardOutputTokens, cardTotalCost, cardTotalRequests].forEach(el => {
    el.classList.remove('loading');
  });

  // Refresh model options (in case new models were added)
  loadModelOptions();

  // Also load chart and breakdown tables
  loadDailyChart();
  loadModelBreakdown();
  loadAgentBreakdown();
}

async function loadModelBreakdown() {
  const tbody = document.getElementById('model-table-body');
  tbody.innerHTML = '<tr><td colspan="5" class="model-table-loading">Loading...</td></tr>';

  try {
    const filterParams = getFilterParams();
    const separator = filterParams ? '&' : '';
    const data = await fetchJSON('/api/usage?group_by=model' + separator + filterParams);
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="model-table-empty">No usage data</td></tr>';
      return;
    }

    // Sort by total cost descending
    data.sort((a, b) => (b.totalCostUsd || 0) - (a.totalCostUsd || 0));

    tbody.innerHTML = data.map(row => `
      <tr>
        <td class="model-name">${escapeHtml(row.groupKey)}</td>
        <td class="numeric">${formatNumber(row.totalInputTokens)}</td>
        <td class="numeric">${formatNumber(row.totalOutputTokens)}</td>
        <td class="numeric">${formatCurrency(row.totalCostUsd)}</td>
        <td class="numeric">${formatNumber(row.recordCount)}</td>
      </tr>
    `).join('');
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="5" class="model-table-empty">Error loading data</td></tr>';
  }
}

async function loadAgentBreakdown() {
  const tbody = document.getElementById('agent-table-body');
  tbody.innerHTML = '<tr><td colspan="5" class="model-table-loading">Loading...</td></tr>';

  try {
    const filterParams = getFilterParams();
    const separator = filterParams ? '&' : '';
    const data = await fetchJSON('/api/usage?group_by=agent' + separator + filterParams);
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="model-table-empty">No usage data</td></tr>';
      return;
    }

    // Sort by total cost descending
    data.sort((a, b) => (b.totalCostUsd || 0) - (a.totalCostUsd || 0));

    tbody.innerHTML = data.map(row => `
      <tr>
        <td class="model-name">${escapeHtml(row.groupKey)}</td>
        <td class="numeric">${formatNumber(row.totalInputTokens)}</td>
        <td class="numeric">${formatNumber(row.totalOutputTokens)}</td>
        <td class="numeric">${formatCurrency(row.totalCostUsd)}</td>
        <td class="numeric">${formatNumber(row.recordCount)}</td>
      </tr>
    `).join('');
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="5" class="model-table-empty">Error loading data</td></tr>';
  }
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ── Daily Usage Chart ─────────────────────────────────────────────
async function loadDailyChart() {
  const container = document.getElementById('daily-chart-content');
  container.innerHTML = '<div class="daily-chart-loading">Loading...</div>';

  try {
    const filterParams = getFilterParams();
    const separator = filterParams ? '&' : '';
    const data = await fetchJSON('/api/usage?group_by=day' + separator + filterParams);

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="daily-chart-empty">No usage data for selected period</div>';
      return;
    }

    // Sort by date ascending
    data.sort((a, b) => (a.groupKey || '').localeCompare(b.groupKey || ''));

    renderDailyChart(container, data);
  } catch (e) {
    container.innerHTML = '<div class="daily-chart-empty">Error loading chart data</div>';
  }
}

function renderDailyChart(container, data) {
  const margin = { top: 20, right: 20, bottom: 40, left: 60 };
  const width = container.clientWidth || 600;
  const height = 200;
  const chartWidth = width - margin.left - margin.right;
  const chartHeight = height - margin.top - margin.bottom;

  // Find max cost for y-axis scale
  const maxCost = Math.max(...data.map(d => d.totalCostUsd || 0), 0.01);
  
  // Bar width with gap
  const barCount = data.length;
  const barGap = Math.max(2, Math.min(8, chartWidth / barCount / 4));
  const barWidth = Math.max(4, (chartWidth - (barCount - 1) * barGap) / barCount);

  // Y-axis scale
  function yScale(value) {
    return chartHeight - (value / maxCost) * chartHeight;
  }

  // Format date for display (shorter format)
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    if (parts.length >= 3) {
      return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
    }
    return dateStr;
  }

  // Generate Y-axis ticks
  function generateYTicks(max, tickCount = 5) {
    const step = max / (tickCount - 1);
    const ticks = [];
    for (let i = 0; i < tickCount; i++) {
      ticks.push(step * i);
    }
    return ticks;
  }

  const yTicks = generateYTicks(maxCost);

  // Build SVG
  let svg = `<svg class="daily-chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

  // Y-axis grid lines and labels
  yTicks.forEach(tick => {
    const y = margin.top + yScale(tick);
    svg += `<line class="daily-chart-grid-line" x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" />`;
    svg += `<text class="daily-chart-axis-label" x="${margin.left - 8}" y="${y + 3}" text-anchor="end">$${tick.toFixed(2)}</text>`;
  });

  // X-axis line
  svg += `<line class="daily-chart-axis-line" x1="${margin.left}" y1="${margin.top + chartHeight}" x2="${width - margin.right}" y2="${margin.top + chartHeight}" />`;

  // Bars
  data.forEach((d, i) => {
    const x = margin.left + i * (barWidth + barGap);
    const barHeight = (d.totalCostUsd || 0) / maxCost * chartHeight;
    const y = margin.top + chartHeight - barHeight;
    
    svg += `<rect class="daily-chart-bar" x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" data-date="${escapeHtml(d.groupKey)}" data-cost="${(d.totalCostUsd || 0).toFixed(4)}" />`;
  });

  // X-axis labels (show every Nth to avoid overlap)
  const labelStep = Math.max(1, Math.ceil(data.length / 10));
  data.forEach((d, i) => {
    if (i % labelStep === 0 || i === data.length - 1) {
      const x = margin.left + i * (barWidth + barGap) + barWidth / 2;
      const y = margin.top + chartHeight + 16;
      svg += `<text class="daily-chart-axis-label" x="${x}" y="${y}" text-anchor="middle">${formatDate(d.groupKey)}</text>`;
    }
  });

  svg += '</svg>';
  
  // Add tooltip container
  svg += '<div class="daily-chart-tooltip" id="daily-chart-tooltip" style="display:none"></div>';
  
  container.innerHTML = svg;

  // Add hover handlers
  const tooltip = document.getElementById('daily-chart-tooltip');
  const bars = container.querySelectorAll('.daily-chart-bar');
  
  bars.forEach(bar => {
    bar.addEventListener('mouseenter', (e) => {
      const date = bar.getAttribute('data-date');
      const cost = parseFloat(bar.getAttribute('data-cost'));
      tooltip.innerHTML = `<div class="daily-chart-tooltip-date">${date}</div><div class="daily-chart-tooltip-value">${formatCurrency(cost)}</div>`;
      tooltip.style.display = 'block';
    });

    bar.addEventListener('mousemove', (e) => {
      const containerRect = container.getBoundingClientRect();
      tooltip.style.left = (e.clientX - containerRect.left + 12) + 'px';
      tooltip.style.top = (e.clientY - containerRect.top - 40) + 'px';
    });

    bar.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });
  });
}

// ── Usage Log ─────────────────────────────────────────────────────
let usageLogOffset = 0;
const usageLogLimit = 50;
let usageLogTotal = 0;
let usageLogOpen = false;

(function initUsageLog() {
  const header = document.getElementById('usage-log-header');
  const content = document.getElementById('usage-log-content');
  const chevron = document.getElementById('usage-log-chevron');
  const prevBtn = document.getElementById('usage-log-prev');
  const nextBtn = document.getElementById('usage-log-next');

  header.addEventListener('click', () => {
    usageLogOpen = !usageLogOpen;
    content.classList.toggle('open', usageLogOpen);
    chevron.classList.toggle('open', usageLogOpen);
    if (usageLogOpen) {
      usageLogOffset = 0;
      loadUsageLog();
    }
  });

  prevBtn.addEventListener('click', () => {
    if (usageLogOffset > 0) {
      usageLogOffset = Math.max(0, usageLogOffset - usageLogLimit);
      loadUsageLog();
    }
  });

  nextBtn.addEventListener('click', () => {
    if (usageLogOffset + usageLogLimit < usageLogTotal) {
      usageLogOffset += usageLogLimit;
      loadUsageLog();
    }
  });
})();

async function loadUsageLog() {
  const tbody = document.getElementById('usage-log-body');
  const countEl = document.getElementById('usage-log-count');
  const infoEl = document.getElementById('usage-log-pagination-info');
  const prevBtn = document.getElementById('usage-log-prev');
  const nextBtn = document.getElementById('usage-log-next');

  tbody.innerHTML = '<tr><td colspan="7" class="usage-log-loading">Loading...</td></tr>';

  try {
    const filterParams = getFilterParams();
    const params = new URLSearchParams(filterParams);
    params.set('limit', usageLogLimit.toString());
    params.set('offset', usageLogOffset.toString());
    
    const data = await fetchJSON('/api/usage/log?' + params.toString());
    usageLogTotal = data.total;

    countEl.textContent = `${formatNumber(data.total)} records`;

    if (!data.records || data.records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="usage-log-empty">No usage records</td></tr>';
      infoEl.textContent = 'No records';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }

    tbody.innerHTML = data.records.map(r => {
      const ts = r.createdAt ? new Date(r.createdAt).toLocaleString() : '—';
      const inputTokens = r.inputTokens != null ? formatNumber(r.inputTokens) : '—';
      const outputTokens = r.outputTokens != null ? formatNumber(r.outputTokens) : '—';
      const cost = r.costUsd != null ? formatCurrency(r.costUsd) : '—';
      return `
        <tr>
          <td class="timestamp">${escapeHtml(ts)}</td>
          <td>${escapeHtml(r.agentId || '—')}</td>
          <td>${escapeHtml(r.model || '—')}</td>
          <td class="numeric">${inputTokens}</td>
          <td class="numeric">${outputTokens}</td>
          <td class="numeric">${cost}</td>
          <td class="task-cell" title="${escapeHtml(r.taskLabel || '')}">${escapeHtml(r.taskLabel || '—')}</td>
        </tr>
      `;
    }).join('');

    // Update pagination info
    const start = data.offset + 1;
    const end = Math.min(data.offset + data.records.length, data.total);
    infoEl.textContent = `Showing ${start}–${end} of ${formatNumber(data.total)}`;

    // Update button states
    prevBtn.disabled = data.offset === 0;
    nextBtn.disabled = data.offset + data.limit >= data.total;
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="7" class="usage-log-empty">Error loading data</td></tr>';
    infoEl.textContent = 'Error';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
  }
}

// ── Theme toggle ──────────────────────────────────────────────────
(function initTheme() {
  const btn = document.getElementById('theme-toggle');
  const root = document.documentElement;
  const STORAGE_KEY = 'antfarm-theme';

  function getEffectiveTheme() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    btn.textContent = theme === 'dark' ? '🌙' : '☀️';
    btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
  }

  applyTheme(getEffectiveTheme());

  btn.addEventListener('click', () => {
    const current = root.getAttribute('data-theme') || getEffectiveTheme();
    const next = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem(STORAGE_KEY, next);
    applyTheme(next);
  });

  // Update if system preference changes and no manual override
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (!localStorage.getItem(STORAGE_KEY)) applyTheme(getEffectiveTheme());
  });
})();
</script>
</body>
</html>
