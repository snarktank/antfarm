<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antfarm Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Geist+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#FAF8F5;color:#3A3226;min-height:100vh}
header{background:#6B7F3B;border-bottom:2px solid #5a6b32;padding:12px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
header img{height:36px;border-radius:6px}
header h1{font-family:'Inter',sans-serif;font-size:22px;font-weight:600;color:#fff;letter-spacing:0}
header h1 span{color:#D4E8A0}
select{background:#5a6b32;color:#fff;border:1px solid #4a5a28;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer}
select option{background:#5a6b32;color:#fff}
select:focus{outline:none;border-color:#8ECFC0}
.board{display:flex;gap:16px;padding:24px;overflow-x:auto;min-height:calc(100vh - 65px)}
.column{min-width:240px;flex:1;background:#fff;border:none;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(58,50,38,.1)}
.column-header{padding:12px 16px;border-bottom:1px solid #eee;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#6B7F3B;background:#f5f0e8;border-radius:8px 8px 0 0}
.column-header .count{background:#6B7F3B;color:#fff;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:8px}
.cards{padding:8px;flex:1;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.card{background:#FAF8F5;border:1px solid #D4C4A0;border-radius:6px;padding:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.card:hover{border-color:#E8845C;box-shadow:0 2px 8px rgba(232,132,92,.15)}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(58,50,38,.5);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s}
.overlay.open{opacity:1;pointer-events:auto}
.panel{background:#fff;border:1px solid #D4C4A0;border-radius:12px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto;padding:24px;position:relative;box-shadow:0 8px 32px rgba(58,50,38,.15)}
.panel-close{position:absolute;top:12px;right:16px;background:none;border:none;color:#8b8072;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.panel-close:hover{color:#3A3226;background:#f5f0e8}
.panel h2{font-size:16px;font-weight:600;color:#3A3226;margin-bottom:4px;padding-right:40px}
.panel-task{font-size:13px;color:#8b8072;margin-bottom:16px;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow-y:auto;line-height:1.5}
.panel-meta{display:flex;gap:12px;margin-bottom:20px;font-size:12px;color:#8b8072;flex-wrap:wrap}
.panel-meta span{display:flex;align-items:center;gap:4px}
.steps-list{display:flex;flex-direction:column;gap:8px}
.step-row{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#FAF8F5;border:1px solid #D4C4A0;border-radius:6px}
.step-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.step-icon.done{background:#6B7F3B22;color:#6B7F3B}
.step-icon.running{background:#8ECFC033;color:#3a9e8a}
.step-icon.pending{background:#D4C4A044;color:#8b8072}
.step-icon.waiting{background:#D4C4A044;color:#8b8072}
.step-icon.failed,.step-icon.error{background:#E8845C22;color:#d4603a}
.step-name{font-size:13px;font-weight:500;color:#3A3226;flex:1}
.step-agent{font-size:11px;color:#8b8072;font-family:'Geist Mono',monospace}
.step-status{font-size:11px;text-transform:uppercase;font-weight:600}
.card-title{font-size:13px;font-weight:500;color:#3A3226;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-meta{font-size:11px;color:#8b8072;display:flex;justify-content:space-between;align-items:center}
.badge{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;text-transform:uppercase}
.badge-running{background:#8ECFC033;color:#3a9e8a}
.badge-done,.badge-completed{background:#6B7F3B22;color:#6B7F3B}
.badge-failed,.badge-error{background:#E8845C22;color:#d4603a}
.badge-waiting{background:#D4C4A044;color:#8b8072}
.badge-pending{background:#D4C4A044;color:#8b8072}
.badge-blocked{background:#E8845C11;color:#E8845C}
.card.done{border-left:3px solid #6B7F3B}
.card.failed,.card.error{border-left:3px solid #E8845C}
.empty{color:#8b8072;font-size:12px;text-align:center;padding:24px 8px}
.refresh-note{color:rgba(255,255,255,.6);font-size:11px;margin-left:auto}
.backlog-col{min-width:280px;max-width:320px;flex:0 0 280px}
.backlog-form{padding:12px;border-bottom:1px solid #eee;display:flex;flex-direction:column;gap:8px}
.backlog-form input,.backlog-form textarea,.backlog-form select{font-family:inherit;font-size:13px;padding:8px 10px;border:1px solid #D4C4A0;border-radius:6px;background:#FAF8F5;color:#3A3226;resize:vertical}
.backlog-form input:focus,.backlog-form textarea:focus,.backlog-form select:focus{outline:none;border-color:#6B7F3B}
.backlog-form textarea{min-height:48px;max-height:96px}
.backlog-form button{background:#6B7F3B;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s}
.backlog-form button:hover{background:#5a6b32}
.backlog-card{position:relative}
.backlog-card .card-desc{font-size:11px;color:#8b8072;margin:4px 0 6px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.4}
.backlog-card .card-actions{display:flex;gap:6px;align-items:center;margin-top:6px}
.backlog-card .dispatch-btn{background:#E8845C;color:#fff;border:none;border-radius:4px;padding:3px 8px;font-size:10px;font-weight:600;cursor:pointer;text-transform:uppercase}
.backlog-card .dispatch-btn:hover{background:#d4603a}
.backlog-card .dispatch-btn:disabled{opacity:.5;cursor:not-allowed}
.badge-workflow{background:#8ECFC033;color:#3a9e8a;font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px}
.badge-backlog-status{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px}
.badge-backlog-draft{background:#D4C4A044;color:#8b8072}
.badge-backlog-ready{background:#6B7F3B22;color:#6B7F3B}
.badge-backlog-dispatched{background:#8ECFC033;color:#3a9e8a}
@media(max-width:768px){.board{flex-direction:column}.column{min-width:unset}}
.story-open{display:block!important}
.story-chevron-open{transform:rotate(90deg)}
.backlog-card.dispatched{opacity:.6;border-left:3px solid #3a9e8a}
.backlog-card.dispatched .card-title{text-decoration:line-through;color:#8b8072}
.reorder-btns{display:flex;flex-direction:column;gap:1px;margin-left:auto}
.reorder-btns button{background:none;border:1px solid #D4C4A0;border-radius:3px;width:22px;height:16px;cursor:pointer;font-size:9px;line-height:1;color:#8b8072;padding:0;display:flex;align-items:center;justify-content:center}
.reorder-btns button:hover{background:#f5f0e8;color:#3A3226}
.bl-panel-field{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.bl-panel-field label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:#6B7F3B}
.bl-panel-field input,.bl-panel-field textarea,.bl-panel-field select{font-family:inherit;font-size:13px;padding:8px 10px;border:1px solid #D4C4A0;border-radius:6px;background:#FAF8F5;color:#3A3226;resize:vertical}
.bl-panel-field textarea{min-height:80px}
.bl-panel-actions{display:flex;gap:8px;margin-top:16px}
.bl-panel-actions button{border:none;border-radius:6px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s}
.bl-btn-save{background:#6B7F3B;color:#fff}
.bl-btn-save:hover{background:#5a6b32}
.bl-btn-delete{background:#E8845C;color:#fff}
.bl-btn-delete:hover{background:#d4603a}
.bl-btn-dispatch{background:#3a9e8a;color:#fff}
.bl-btn-dispatch:hover{background:#2d8a77}
.bl-btn-dispatch:disabled{opacity:.5;cursor:not-allowed}
.bl-run-link{display:inline-block;margin-top:8px;font-size:12px;color:#3a9e8a;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1><span>antfarm</span> dashboard</h1>
  <select id="wf-select"><option value="">Loading...</option></select>
  <span class="refresh-note" id="refresh-note">Auto-refresh: 30s</span>
</header>
<div class="board" id="board"><div class="empty" style="margin:auto">Loading...</div></div>
<div class="overlay" id="overlay" onclick="if(event.target===this)closePanel()">
  <div class="panel" id="panel"></div>
</div>

<script>
const API = '';
let workflows = [];
let currentWf = null;
let backlogItems = [];

async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function loadBacklog() {
  try { backlogItems = await fetchJSON('/api/backlog'); } catch { backlogItems = []; }
}

function renderBacklogCards() {
  return backlogItems.length === 0
    ? '<div class="empty">No backlog items</div>'
    : backlogItems.map((item, idx) => {
        const desc = item.description ? (item.description.length > 80 ? item.description.slice(0, 77) + '…' : item.description) : '';
        const wfBadge = item.target_workflow ? `<span class="badge-workflow">${esc(item.target_workflow)}</span>` : '';
        const isDispatched = item.status === 'dispatched';
        return `<div class="card backlog-card ${isDispatched ? 'dispatched' : ''}" onclick="openBacklogDetail('${item.id}')">
          <div style="display:flex;align-items:flex-start;gap:8px">
            <div style="flex:1;min-width:0">
              <div class="card-title" title="${esc(item.title)}">${esc(item.title)}</div>
              ${desc ? `<div class="card-desc">${esc(desc)}</div>` : ''}
              <div class="card-meta">
                <span class="badge-backlog-status badge-backlog-${item.status}">${item.status}</span>
                ${wfBadge}
              </div>
            </div>
            <div class="reorder-btns" onclick="event.stopPropagation()">
              <button onclick="reorderBacklog('${item.id}', ${item.priority - 1})" ${idx === 0 ? 'disabled' : ''} title="Move up">▲</button>
              <button onclick="reorderBacklog('${item.id}', ${item.priority + 1})" ${idx === backlogItems.length - 1 ? 'disabled' : ''} title="Move down">▼</button>
            </div>
          </div>
        </div>`;
      }).join('');
}

function renderBacklogForm() {
  const wfOptions = workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  return `<div class="backlog-form">
    <input type="text" id="bl-title" placeholder="Title" />
    <textarea id="bl-desc" placeholder="Description (optional)"></textarea>
    <select id="bl-workflow"><option value="">— workflow —</option>${wfOptions}</select>
    <button onclick="addBacklogItem()">Add</button>
  </div>`;
}

function renderBacklogColumn() {
  return `<div class="column backlog-col">
    <div class="column-header">Backlog<span class="count" id="backlog-count">${backlogItems.length}</span></div>
    ${renderBacklogForm()}
    <div class="cards" id="backlog-cards">${renderBacklogCards()}</div>
  </div>`;
}

function refreshBacklogCards() {
  const cards = document.getElementById('backlog-cards');
  const count = document.getElementById('backlog-count');
  if (cards) cards.innerHTML = renderBacklogCards();
  if (count) count.textContent = String(backlogItems.length);
}

function getBacklogFormState() {
  const title = document.getElementById('bl-title');
  const desc = document.getElementById('bl-desc');
  const workflow = document.getElementById('bl-workflow');
  if (!title || !desc || !workflow) return null;
  const active = document.activeElement;
  return {
    title: title.value,
    desc: desc.value,
    workflow: workflow.value,
    activeId: active && active.id ? active.id : null,
    selectionStart: active && typeof active.selectionStart === 'number' ? active.selectionStart : null,
    selectionEnd: active && typeof active.selectionEnd === 'number' ? active.selectionEnd : null
  };
}

function restoreBacklogFormState(state) {
  if (!state) return;
  const title = document.getElementById('bl-title');
  const desc = document.getElementById('bl-desc');
  const workflow = document.getElementById('bl-workflow');
  if (!title || !desc || !workflow) return;
  title.value = state.title;
  desc.value = state.desc;
  workflow.value = state.workflow;
  if (state.activeId) {
    const el = document.getElementById(state.activeId);
    if (el) {
      el.focus();
      if (typeof state.selectionStart === 'number' && typeof state.selectionEnd === 'number' && typeof el.setSelectionRange === 'function') {
        el.setSelectionRange(state.selectionStart, state.selectionEnd);
      }
    }
  }
}

async function addBacklogItem() {
  const title = document.getElementById('bl-title').value.trim();
  if (!title) return;
  const desc = document.getElementById('bl-desc').value.trim();
  const wf = document.getElementById('bl-workflow').value;
  const body = { title, description: desc };
  if (wf) body.target_workflow = wf;
  await fetch(API + '/api/backlog', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  document.getElementById('bl-title').value = '';
  document.getElementById('bl-desc').value = '';
  document.getElementById('bl-workflow').value = '';
  await loadBacklog();
  refreshBoard();
}

async function dispatchBacklog(id) {
  try {
    const r = await fetch(API + `/api/backlog/${id}/dispatch`, { method: 'POST' });
    const data = await r.json();
    await loadBacklog();
    if (currentWf) await loadRuns();
    else refreshBoard();
    if (data.run_id) {
      closePanel();
    }
  } catch (e) { console.error('Dispatch failed', e); }
}

async function reorderBacklog(id, newPriority) {
  await fetch(API + `/api/backlog/${id}/reorder`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ priority: newPriority }) });
  await loadBacklog();
  refreshBoard();
}

async function openBacklogDetail(id) {
  const item = backlogItems.find(i => i.id === id);
  if (!item) return;
  const wfOptions = workflows.map(w => `<option value="${w.id}" ${w.id === item.target_workflow ? 'selected' : ''}>${w.name}</option>`).join('');
  const isDispatched = item.status === 'dispatched';
  const panel = document.getElementById('panel');
  panel.innerHTML = `
    <button class="panel-close" onclick="closePanel()">✕</button>
    <h2>Backlog Item</h2>
    <div class="bl-panel-field">
      <label>Title</label>
      <input type="text" id="bl-edit-title" value="${esc(item.title)}" ${isDispatched ? 'disabled' : ''} />
    </div>
    <div class="bl-panel-field">
      <label>Description</label>
      <textarea id="bl-edit-desc" ${isDispatched ? 'disabled' : ''}>${esc(item.description || '')}</textarea>
    </div>
    <div class="bl-panel-field">
      <label>Target Workflow</label>
      <select id="bl-edit-wf" ${isDispatched ? 'disabled' : ''}>
        <option value="">— none —</option>
        ${wfOptions}
      </select>
    </div>
    <div class="panel-meta">
      <span>Status: <span class="badge-backlog-status badge-backlog-${item.status}">${item.status}</span></span>
      <span>Priority: ${item.priority}</span>
      <span>Created: ${new Date(item.created_at).toLocaleString()}</span>
    </div>
    ${isDispatched ? '<div class="bl-run-link" onclick="findDispatchedRun(\'' + esc(item.title) + '\')">View dispatched run →</div>' : ''}
    <div class="bl-panel-actions">
      ${!isDispatched ? `<button class="bl-btn-save" onclick="saveBacklogItem('${item.id}')">Save</button>` : ''}
      <button class="bl-btn-dispatch" id="bl-dispatch-btn" onclick="dispatchBacklogFromPanel('${item.id}')" ${(!item.target_workflow || isDispatched) ? 'disabled' : ''}>Dispatch</button>
      <button class="bl-btn-delete" onclick="deleteBacklogItem('${item.id}')">Delete</button>
    </div>
  `;
  // Update dispatch button state when workflow changes
  if (!isDispatched) {
    document.getElementById('bl-edit-wf').addEventListener('change', function() {
      document.getElementById('bl-dispatch-btn').disabled = !this.value;
    });
  }
  document.getElementById('overlay').classList.add('open');
}

async function saveBacklogItem(id) {
  const title = document.getElementById('bl-edit-title').value.trim();
  const description = document.getElementById('bl-edit-desc').value.trim();
  const target_workflow = document.getElementById('bl-edit-wf').value || null;
  if (!title) return alert('Title is required');
  await fetch(API + `/api/backlog/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, description, target_workflow }) });
  await loadBacklog();
  refreshBoard();
  closePanel();
}

async function deleteBacklogItem(id) {
  if (!confirm('Delete this backlog item?')) return;
  await fetch(API + `/api/backlog/${id}`, { method: 'DELETE' });
  await loadBacklog();
  refreshBoard();
  closePanel();
}

async function dispatchBacklogFromPanel(id) {
  // Save first in case workflow was changed
  const wf = document.getElementById('bl-edit-wf').value;
  if (!wf) return;
  await fetch(API + `/api/backlog/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ target_workflow: wf }) });
  await dispatchBacklog(id);
}

function findDispatchedRun(title) {
  closePanel();
  // If a workflow is selected, the run should be visible on the board
  // Just close panel — run is already on the board
}

function refreshBoard() {
  const board = document.getElementById('board');
  if (currentWf) { loadRuns(); return; }
  const formState = getBacklogFormState();
  board.innerHTML = renderBacklogColumn() + '<div class="empty" style="margin:auto">Select a workflow</div>';
  restoreBacklogFormState(formState);
}

async function loadWorkflows() {
  workflows = await fetchJSON('/api/workflows');
  await loadBacklog();
  const sel = document.getElementById('wf-select');
  sel.innerHTML = '<option value="">— select workflow —</option>' +
    workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  if (workflows.length === 1) {
    sel.value = workflows[0].id;
    selectWorkflow(workflows[0].id);
  } else if (workflows.length > 1) {
    // Auto-select workflow with active runs
    try {
      for (const w of workflows) {
        const runs = await fetchJSON(`/api/runs?workflow=${w.id}`);
        const active = runs.find(r => r.status === 'running' || r.status === 'pending');
        if (active) { sel.value = w.id; selectWorkflow(w.id); break; }
      }
    } catch {}
  }
}

function selectWorkflow(id) {
  currentWf = workflows.find(w => w.id === id) || null;
  if (currentWf) loadRuns();
  else {
    const formState = getBacklogFormState();
    document.getElementById('board').innerHTML = renderBacklogColumn() + '<div class="empty" style="margin:auto">Select a workflow</div>';
    restoreBacklogFormState(formState);
  }
}

async function loadRuns() {
  if (!currentWf) return;
  const runs = await fetchJSON(`/api/runs?workflow=${currentWf.id}`);
  renderBoard(currentWf, runs);
}

function getActiveStepId(run) {
  if (!run.steps || !run.steps.length) return null;
  const active = run.steps.find(s => s.status !== 'done' && s.status !== 'skipped');
  return active ? active.step_id : run.steps[run.steps.length - 1].step_id;
}

function renderBoard(wf, runs) {
  const board = document.getElementById('board');
  const formState = getBacklogFormState();
  const columns = {};
  wf.steps.forEach(s => { columns[s.id] = []; });

  runs.forEach(run => {
    const stepId = getActiveStepId(run);
    const col = stepId && columns[stepId] !== undefined ? stepId : wf.steps[wf.steps.length - 1]?.id;
    if (col && columns[col]) columns[col].push(run);
  });

  board.innerHTML = renderBacklogColumn() + wf.steps.map(step => {
    const cards = columns[step.id];
    const cardHTML = cards.length === 0
      ? '<div class="empty">No runs</div>'
      : cards.map(run => {
          const isDone = run.status === 'done';
          const isFailed = run.status === 'failed' || run.status === 'error';
          const cls = isDone ? 'done' : isFailed ? 'failed' : '';
          const badge = `badge-${run.status}`;
          const time = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
          const title = run.task.length > 60 ? run.task.slice(0, 57) + '…' : run.task;
          return `<div class="card ${cls}" onclick="openRun('${run.id}')">
            <div class="card-title" title="${run.task.replace(/"/g, '&quot;')}">${title}</div>
            <div class="card-meta">
              <span class="badge ${badge}">${run.status}</span>
              <span>${time}</span>
            </div>
          </div>`;
        }).join('');
    return `<div class="column">
      <div class="column-header">${step.id}<span class="count">${cards.length}</span></div>
      <div class="cards">${cardHTML}</div>
    </div>`;
  }).join('');
  restoreBacklogFormState(formState);
}

const stepIcons = {done:'✓',running:'●',pending:'○',waiting:'◌',failed:'✗',error:'✗'};
function esc(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function openRun(id) {
  const run = await fetchJSON(`/api/runs/${id}`);
  const panel = document.getElementById('panel');
  const created = run.created_at ? new Date(run.created_at).toLocaleString() : '';
  const updated = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
  const stepsHTML = (run.steps || []).map(s => {
    const st = s.status || 'waiting';
    const icon = stepIcons[st] || '○';
    return `<div class="step-row">
      <div class="step-icon ${st}">${icon}</div>
      <div class="step-name">${s.step_id}</div>
      <div class="step-agent">${s.agent_id || ''}</div>
      <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
    </div>`;
  }).join('');
  panel.innerHTML = `
    <button class="panel-close" onclick="closePanel()">✕</button>
    <h2>${run.workflow_id}</h2>
    <div class="panel-task">${esc(run.task)}</div>
    <div class="panel-meta">
      <span><span class="badge badge-${run.status}">${run.status}</span></span>
      <span>Created: ${created}</span>
      <span>Updated: ${updated}</span>
    </div>
    <div class="steps-list">${stepsHTML}</div>
    <div id="stories-panel"></div>
  `;
  document.getElementById('overlay').classList.add('open');
  loadStories(id);
}

function closePanel() {
  document.getElementById('overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

async function loadStories(runId) {
  const stories = await fetchJSON(`/api/runs/${runId}/stories`);
  const panel = document.getElementById('stories-panel');
  if (!stories || stories.length === 0) { panel.innerHTML = ''; return; }
  const done = stories.filter(s => s.status === 'done').length;
  const pct = Math.round((done / stories.length) * 100);
  panel.innerHTML = `
    <div style="margin-top:24px;border-top:1px solid #D4C4A0;padding-top:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-size:15px;font-weight:600;color:#3A3226">Stories</h3>
        <span style="font-size:13px;font-weight:600;color:#6B7F3B">${done} / ${stories.length} done</span>
      </div>
      <div style="background:#D4C4A044;border-radius:4px;height:8px;margin-bottom:16px;overflow:hidden">
        <div style="background:#6B7F3B;height:100%;width:${pct}%;border-radius:4px;transition:width .3s"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${stories.map((s, i) => {
          const st = s.status || 'pending';
          const icon = stepIcons[st] || '○';
          let ac = [];
          try { ac = JSON.parse(s.acceptance_criteria || '[]'); } catch { ac = [s.acceptance_criteria]; }
          const retryInfo = s.retry_count > 0 ? ` <span style="color:#E8845C;font-size:10px">(retry ${s.retry_count})</span>` : '';
          const hasDetails = s.description || ac.length > 0 || s.output;
          const toggleAttr = hasDetails ? `onclick="this.querySelector('.story-details').classList.toggle('story-open');this.querySelector('.story-chevron').classList.toggle('story-chevron-open')" style="cursor:pointer"` : '';
          return `<div class="step-row" style="flex-direction:column;align-items:stretch;gap:0;padding:0;overflow:hidden" ${toggleAttr}>
            <div style="display:flex;align-items:center;gap:8px;padding:10px 12px">
              <div class="step-icon ${st}">${icon}</div>
              <div class="step-name" style="flex:1">${s.story_id}: ${s.title}${retryInfo}</div>
              <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
              ${hasDetails ? '<span class="story-chevron" style="color:#8b8072;font-size:10px;transition:transform .15s;display:inline-block">▶</span>' : ''}
            </div>
            ${hasDetails ? `<div class="story-details" style="display:none;padding:0 12px 12px 44px;font-size:12px;color:#5a5045;line-height:1.6">
              ${s.description ? `<div style="margin-bottom:8px">${esc(s.description)}</div>` : ''}
              ${ac.length > 0 ? `<div style="margin-bottom:8px"><div style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.3px;color:#6B7F3B;margin-bottom:4px">Acceptance Criteria</div>${ac.map(c => `<label style="display:flex;align-items:flex-start;gap:6px;margin-bottom:3px;cursor:default"><span style="color:${st==='done'?'#6B7F3B':'#D4C4A0'};flex-shrink:0">${st==='done'?'☑':'☐'}</span><span>${esc(c)}</span></label>`).join('')}</div>` : ''}
              ${s.output ? `<details style="margin-top:4px" onclick="event.stopPropagation()"><summary style="font-size:11px;color:#8b8072;cursor:pointer;font-weight:500">Output</summary><pre style="margin-top:6px;padding:8px;background:#FAF8F5;border:1px solid #D4C4A0;border-radius:4px;font-family:'Geist Mono',monospace;font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto">${esc(s.output)}</pre></details>` : ''}
            </div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}

document.getElementById('wf-select').addEventListener('change', e => selectWorkflow(e.target.value));
loadWorkflows();
setInterval(async () => {
  await loadBacklog();
  refreshBacklogCards();
  if (currentWf) loadRuns();
  else refreshBoard();
}, 30000);
</script>
</body>
</html>
